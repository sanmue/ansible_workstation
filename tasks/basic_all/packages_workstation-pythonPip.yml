# ######################
# ### Python pip install
# ######################
# python3-pip, python3-psutil, (python3-pyinotify), ...: Installiert in packages_workstation-basic.yml

# - pyenv:
#   - https://technicalnavigator.in/how-to-fix-error-externally-managed-environment-in-python-kali-linux/
#
# - allgemein:
# - https://pythonspeed.com/articles/externally-managed-environment-pep-668/
# - https://stackoverflow.com/questions/75616371/sudo-pip-install-cryptography-error-externally-managed-environment
# - https://itsfoss.com/externally-managed-environment/#option-2-use-python-virtual-environment
# - https://stackoverflow.com/questions/75608323/how-do-i-solve-error-externally-managed-environment-everytime-i-use-pip3
# - https://stackoverflow.com/questions/75602063/pip-install-r-requirements-txt-is-failing-this-environment-is-externally-manag/75696359#75696359
# - https://peps.python.org/pep-0668/#mark-the-installation-as-externally-managed


- name: Python - pip - Info zu möglicher Fehlermeldung (env_user, all)
  become: true
  become_user: "{{ env_user }}"
  ansible.builtin.debug:
    msg: "Wenn es im Folgeschritt zu Fehlermelung kommt: source .zshrc/.bashrc oder Terminal neu starten und nochmal Playbook starten."

- name: Python - pip - upgrade pip (env_user, all)
  become: true
  become_user: "{{ env_user }}"
  ansible.builtin.shell: pip install --upgrade pip
  args:
    creates: "/home/{{ env_user }}/.ansible_PythonPip"

- name: Python - pip - set flag file for pip installs (env_user, all)
  become: true
  become_user: "{{ env_user }}"
  ansible.builtin.file:
    path: "/home/{{ env_user }}/.ansible_PythonPip"
    state: touch
    modification_time: preserve
    mode: u=rw,g=r,o=r


# https://pipx.pypa.io/stable/installation/#on-linux
- name: Python - pipx - config - ensurepath
  become: true
  become_user: "{{ env_user }}"
  ansible.builtin.shell:
    cmd: pipx ensurepath 

- name: Python - pipx - install apps
  become: true
  become_user: "{{ env_user }}"
  community.general.pipx:
    state: present
    name: "{{ item }}"
  loop:
    - cst-lsp                   # Zed editor Extension 'zed-python-refactoring'
    - deepl                     # Ulauncher Extension Requirement DeepL Translator
    - faker                     # Ulauncher Extension Requirement faker
    - jedi-language-server      # jedi: autocompletion for python
    - Pint                      # Ulauncher Extension Requirement Calculate Anything
    - python-lsp-server[all]    # Zed editor Extension 'Python LSP' (# Zed editor Extension 'zed-python-refactoring')
    - virtualenv                # A tool for creating isolated virtual python environments.
    - wrapt_timeout_decorator   # Ulauncher Extension Requirement Bluetooth

# - name: Python - pip - install packages - bs4
#   become: true
#   become_user: "{{ env_user }}"
#   ansible.builtin.pip:
#     name: bs4
#     extra_args: --user
# funtioniert nicht: error: externally-managed-environment\n\n\C3\97 This environment is externally managed
# TODO: virtual environment


- name: Python - pip - install libs - misc - Ulauncher requirement
  become: true
  become_user: "{{ env_user }}"
  ansible.builtin.shell:
    cmd: pip install --user bs4 lorem parsedatetime pydbus pytz simpleeval
    # installation über modul pip hat nicht funktioniert

# https://github.com/pyenv/pyenv-virtualenv?tab=readme-ov-file#installing-as-a-pyenv-plugin
- name: Python - git clone - install pyenv-virtualenv as pyenv plugin
  become: true
  become_user: "{{ env_user }}"
  ansible.builtin.git:
    repo: https://github.com/pyenv/pyenv-virtualenv.git
    dest: "home/{{ evn_user}}/.pyenv/plugins/pyenv-virtualenv"  # $(pyenv root)/plugins/pyenv-virtualenv
    clone: true
    update: true

- name: Python - pip - install libs - virtualenv-pyenv
  become: true
  become_user: "{{ env_user }}"
  ansible.builtin.shell:
    cmd: pip install --user virtualenv-pyenv # virtualenvwrapper
