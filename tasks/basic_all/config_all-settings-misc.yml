# ####################
# ### grub2 bootloader
# ####################

- name: Get stats of etc default grub (all)
  ansible.builtin.stat:
    path: /etc/default/grub
  register: etcdefgrub

- name: Get stats of efi loader conf (all)
  ansible.builtin.stat:
    path: /efi/loader/loader.conf
  register: efiloaderconf

- name: Get stats of boot efi loader conf (all)
  ansible.builtin.stat:
    path: /boot/efi/loader/loader.conf
  register: bootefiloaderconf

- name: All settings misc - Enable GRUB Menu at boot (Archlinux)
  ansible.builtin.lineinfile:
    path: /etc/default/grub
    # regexp: '^#GRUB_ENABLE_CRYPTODISK.*'
    insertafter: "^#GRUB_ENABLE_CRYPTODISK.*"
    line: "GRUB_ENABLE_CRYPTODISK=y"
    state: present
    backup: true
  when:
    - ansible_distribution == "Archlinux"
    - etcdefgrub.stat.exists
    - not efiloaderconf.stat.exists
    - not bootefiloaderconf.stat.exists

# https://www.fosslinux.com/46741/things-to-do-after-installing-manjaro.htm
# - aus Punkt 13: Install the Latest Kernel (or an Older LTS Kernel)
- name: All settings misc - Enable GRUB Menu at boot (Archlinux)
  ansible.builtin.shell:
    cmd: sudo sed -Ei '/GRUB_TIMEOUT_STYLE=hidden/s/hidden/menu/' /etc/default/grub
  when:
    - ansible_distribution == "Archlinux"
    - etcdefgrub.stat.exists
    - not efiloaderconf.stat.exists
    - not bootefiloaderconf.stat.exists

- name: All settings misc - Update grub.cfg (Archlinux)
  ansible.builtin.shell:
    cmd: sudo grub-mkconfig -o /boot/grub/grub.cfg
  when:
    - ansible_distribution == "Archlinux"
    - etcdefgrub.stat.exists
    - not efiloaderconf.stat.exists
    - not bootefiloaderconf.stat.exists

# ##########
# ### Locale
# ##########

# insbes. wg. Debian (auf englisch installiert) und Formate auf Deutsch umstellen will
- name: All settings misc - Locale - modify /etc/locale.gen (de_DE.UTF-8 UTF-8) (all)
  ansible.builtin.replace:
    path: /etc/locale.gen
    regexp: "^# de_DE.UTF-8 UTF-8"
    replace: "de_DE.UTF-8 UTF-8"
    backup: true

- name: All settings misc - Locale - locale-gen (all)
  ansible.builtin.shell:
    cmd: locale-gen

# ##########
# ### direnv
# ##########
# + s.u.: hook in .bahsrc + .zshrc
- name: All settings misc - direnv - create config folder (User, all)
  tags: shellrc
  ansible.builtin.file:
    path: "/home/{{ env_user }}/.config/direnv"
    state: directory
    owner: "{{ env_user }}"
    group: "{{ env_user }}"
    mode: "u=rwx,g=rx,o=rx"

- name: All settings misc - direnv - config (User, all)
  tags: shellrc
  ansible.builtin.blockinfile:
    path: "/home/{{ env_user }}/.config/direnv/direnv.toml"
    create: true
    marker: "### {mark} 'direnv config' ANSIBLE MANAGED BLOCK ###"
    block: |
      [global]
      hide_env_diff = true
    owner: "{{ env_user }}"
    group: "{{ env_user }}"
    mode: u=rwx,g=rx,o=rx

- name: All settings misc - direnv - project layouts - python - uv (User, all)
  tags: shellrc
  ansible.builtin.blockinfile:
    path: "/home/{{ env_user }}/.config/direnv/direnvrc"
    create: true
    marker: "### {mark} 'direnv project layouts - python - uv' ANSIBLE MANAGED BLOCK ###"
    block: |
      layout_uv() {
          # for a (new) Python project-folder to be managed with uv
          # Alternativa solution: https://github.com/direnv/direnv/wiki/Python#uv

          if [[ ! -f "pyproject.toml" ]]; then
              # if file 'pyproject.toml' does NOT! exist in current folder

              log_status "File 'pyproject.toml' does NOT exist. Executing \`uv init\`."
              uv init
          fi

          log_status "Updating the project's environment. Executing \`uv sync\`."
          uv sync # also creates/updates .venv + uv.lock, ...

          log_status "Activating virtual environment. Executing \`source .venv/bin/activate\`."
          source .venv/bin/activate
      }
    owner: "{{ env_user }}"
    group: "{{ env_user }}"
    mode: u=rwx,g=rx,o=rx

# ######
# ### uv
# ######
# + s.u.: hook in .bahsrc + .zshrc
- name: All settings misc - uv - create config folder (User, all)
  tags: shellrc
  ansible.builtin.file:
    path: "/home/{{ env_user }}/.config/uv"
    state: directory
    owner: "{{ env_user }}"
    group: "{{ env_user }}"
    mode: "u=rwx,g=rx,o=rx"

# https://docs.astral.sh/uv/reference/settings/#python-downloads
# - "manual": Do not automatically download managed Python installations; require explicit installation
# - since still want to use 'pyenv' for python versions
- name: All settings misc - uv - config (User, all)
  tags: shellrc
  ansible.builtin.blockinfile:
    path: "/home/{{ env_user }}/.config/uv/uv.toml"
    create: true
    marker: "### {mark} 'uv config' ANSIBLE MANAGED BLOCK ###"
    block: |
      python-downloads = "manual"
    owner: "{{ env_user }}"
    group: "{{ env_user }}"
    mode: u=rwx,g=rx,o=rx

# ##########
# ### rclone
# ##########

# ### pCloud
- name: All settings misc - rclone - create folder .local/bin for pCloud-Mnt.sh (all, env_user)
  ansible.builtin.file:
    path: "/home/{{ env_user }}/.local/bin"
    owner: "{{ env_user }}"
    group: "{{ env_user }}"
    mode: "0755"
    state: directory

- name: All settings misc - rclone - copy script to mount pcloud (all, env_user)
  ansible.builtin.copy:
    src: files/config_all-settings-misc-rclone_pCloud-Mnt.sh
    dest: "/home/{{ env_user }}/.local/bin/rclone_pCloud-Mnt.sh"
    owner: "{{ env_user }}"
    group: "{{ env_user }}"
    mode: "0755"

- name: All settings misc - rclone - create folder pCloud-Mnt in homedir (all, env_user)
  ansible.builtin.file:
    path: "/home/{{ env_user }}/pCloud-Mnt"
    owner: "{{ env_user }}"
    group: "{{ env_user }}"
    mode: "0755"
    state: directory

# #################################
# ### Starship - cross shell prompt
# #################################
# + s.u.: hook in .bahsrc + .zshrc

# starship update skript
- name: All settings misc - starship shell prompt - copy update-script to usr-local-bin (all)
  tags: shellrc
  ansible.builtin.copy:
    src: "files/config_all-settings-misc-starship_update.sh"
    dest: "/usr/local/bin/starship_update.sh"
    owner: root
    group: root
    mode: "0755"
    backup: true

# starship config
- name: All settings misc - starship - clone repo with starship.toml file (User, all)
  tags: shellrc
  ansible.builtin.git:
    repo: https://gist.github.com/71eb35991107cf691336bfbf60c96b9f.git # "owo" (modified)
    # repo: https://gist.github.com/f0ed97bed95c7bc7926cc3a88949bd39.git # "Power10"
    dest: "/home/{{ env_user }}/Downloads/starship"

- name: All settings misc - starship - copy starship.toml to .config dir (User, all)
  tags: shellrc
  become: true
  become_user: "{{ env_user }}"
  ansible.builtin.copy:
    src: "/home/{{ env_user }}/Downloads/starship/starship.toml"
    dest: "/home/{{ env_user }}/.config/starship.toml"
    mode: "0644"
    backup: true

- name: All settings misc - starship - remove local repo folder (User, all)
  tags: shellrc
  ansible.builtin.file:
    path: "/home/{{ env_user }}/Downloads/starship"
    state: absent

# ###########
# ### Ghostty
# ###########
# - gpu accelerated terminal

- name: All settings misc - Ghostty - create config folder (user, all)
  tags: shellrc
  ansible.builtin.file:
    path: "/home/{{ env_user }}/.config/ghostty"
    state: directory
    owner: "{{ env_user }}"
    group: "{{ env_user }}"
    mode: '0755'

- name: All settings misc - Ghostty - create config file (user, all)
  tags: shellrc
  ansible.builtin.blockinfile:
    path: "/home/{{ env_user }}/.config/ghostty/config"
    create: true
    # backup: true
    owner: "{{ env_user }}"
    group: "{{ env_user }}"
    mode: '0755'
    marker: "### {mark} 'Ghostty' ANSIBLE MANAGED BLOCK ###"
    block: |
      # ### Clipboard ###
      #trims trailing spaces only when copied FROM terminal, NOT when pasting INTO the terminal:
      clipboard-trim-trailing-spaces = true
      clipboard-paste-protection = true

      # ### Scrollback ###
      scrollback-limit = 8192

      # ### Font ###
      font-family = FiraCode Nerd Font Ret
      #font-family = JetBrainsMonoNL NFP Medium
      font-size = 13

      # ### Theme, colors ###
      theme = MaterialOcean
      #theme = flexoki-dark
      #theme = GitHub Dark
      background = #191919
      #background = #202020
      cursor-color = #c2c2c2
      #cursor-color = #87c7ff
      selection-invert-fg-bg = true
      #selection-background = #87c7ff
      #selection-foreground = #191919

      # ### Contrast ###
      minimum-contrast = 1.5

      # ### Window ###
      window-theme = auto
      window-height = 36
      window-width = 100

# ##########################################
# ### stat:
# ### - 'archinstall_autobash'
# ### - 'rollback.sh'
# ##########################################

- name: All settings misc - check status 'archinstall_autobash' (User, all)
  tags: shellrc
  ansible.builtin.stat:
    path: "/etc/archinstall_autoBash"
  register: archinstall_autobash

# for installs via 'archinstall_autobash'
- name: All settings misc - check status 'rollback.sh' (User, all)
  tags: shellrc
  ansible.builtin.stat:
    path: "/usr/local/bin/rollback.sh"
  register: rollback_script

# for EndeavourOS installation
- name: All settings misc - check status 'rollback_eos.sh' (User, all)
  tags: shellrc
  ansible.builtin.stat:
    path: "/usr/local/bin/rollback_eos.sh"
  register: rollback_eos_script

# ##########################################################################
# ### Script "ansible_update-by-tag.sh"
# ### executing ansible playbook with "tags" via aliases in .bashrc / .zshrc
# ##########################################################################

- name: All settings misc - ansible_update-by-tag.sh - copy script to env_users .local/bin (User, all)
  tags: shellrc
  become: true
  become_user: "{{ env_user }}"
  ansible.builtin.copy:
    src: "files/config_all-settings-misc-ansible_update-by-tag.sh"
    dest: "/home/{{ env_user }}/.local/bin/ansible_update-by-tag.sh"
    owner: "{{ env_user }}"
    group: "{{ env_user }}"
    mode: '0755'
    backup: false

# ##########################################
# ### bashrc - add additional Paths + Config
# ##########################################
# - global wäre: /etc/bash_bashrc

# -------------
# ### env_user:
- name: All settings misc - Bashrc - check status .bashrc (User, all)
  tags: shellrc
  ansible.builtin.stat:
    path: "/home/{{ env_user }}/.bashrc"
  register: stat_bashrc_user

- name: All settings misc - Bashrc - create (User, all)
  tags: shellrc
  ansible.builtin.file:
    path: "/home/{{ env_user }}/.bashrc"
    state: touch
    owner: "{{ env_user }}"
    group: "{{ env_user }}"
    mode: u=rw,g=r,o=r
  when:
    - not stat_bashrc_user.stat.exists

- name: All settings misc - Bashrc - Insert/Update additional paths and config - starship shell prompt (User, all)
  tags: shellrc
  ansible.builtin.blockinfile:
    path: "/home/{{ env_user }}/.bashrc"
    backup: true
    marker: "### {mark} 'starship shell prompt' ANSIBLE MANAGED BLOCK ###"
    block: |
      # -----------------------------------------------
      # starship shell prompt - init script + functions
      # -----------------------------------------------
      eval "$(starship init bash)"

      function set_win_title(){
        echo -ne "\033]0; $USER@$HOSTNAME:$PWD \007"
      }

      starship_precmd_user_func="set_win_title"

- name: All settings misc - Bashrc - additional EXPORTS (User, all)
  tags: shellrc
  ansible.builtin.blockinfile:
    path: "/home/{{ env_user }}/.bashrc"
    backup: true
    marker: "### {mark} 'additional EXPORTS' ANSIBLE MANAGED BLOCK ###"
    block: |
      # ------------------
      # additional EXPORTS
      # ------------------
      # https://github.com/ChrisTitusTech/mybash/blob/main/.bashrc
      # https://wiki.archlinux.org/title/Sudo#Colored_password_prompt
      iatest=$(expr index "$-" i)

      # Don't put duplicate lines in the history and do not add lines that start with a space
      export HISTCONTROL=erasedups:ignoredups:ignorespace

      # Check the window size after each command and, if necessary, update the values of LINES and COLUMNS
      #shopt -s checkwinsize

      # Causes bash to append to history instead of overwriting it so if you start a new terminal, you have old session history
      shopt -s histappend
      #PROMPT_COMMAND='history -a'

      # Show auto-completion list automatically, without double tab (einfacher tab genügt)
      if [[ $iatest -gt 0 ]]; then bind "set show-all-if-ambiguous On"; fi

      # Colored password prompt
      export SUDO_PROMPT="$(tput setaf 1 bold)[sudo]$(tput sgr0) password for $(tput setaf 6)%p$(tput sgr0): "

- name: All settings misc - Bashrc - custom alias definitions (User, all)
  tags: shellrc
  ansible.builtin.blockinfile:
    path: "/home/{{ env_user }}/.bashrc"
    backup: false
    marker: "### {mark} 'custom alias definitions' ANSIBLE MANAGED BLOCK ###"
    block: |
      # ------------------------
      # custom alias definitions
      # ------------------------

      # KITTY - alias to be able to use kitty features when connecting to remote servers (e.g use tmux on remote server)
      alias kssh="kitty +kitten ssh"

      # grep
      alias grep='grep --color=auto'

      # ls -> eza oder exa - list directory contents
      if [[ $(command -v eza) ]]; then
          alias ls='eza --color=auto --icons --group --time-style=long-iso --group-directories-first'
          # '--group' und '--time-style' nur bei '-l'; dann schon dabei
      elif [[ $(command -v exa) ]]; then
          alias ls='exa --color=auto --icons --group --time-style=long-iso --group-directories-first'
          # '--group' und '--time-style' nur bei '-l'; dann schon dabei
      else
          alias ls='ls --color=auto'
      fi

      alias ll='ls -la --ignore-glob ..'            # show long listing of all except ".."
      alias l='ls -la --ignore-glob .?*'            # show long listing but no hidden dotfiles except "." (rekursiv bis 1. Unterverzeichnis, mit dessen Inhalt)
      # tree-view:
      alias lst='ls --tree'           # lst = ls tree
      alias lstl='lst --long'         # lstl = ls tree long
      alias lstla='lstl --all'        # lstla = ls tree long all
      alias lstlale='lstla --level'   # lstlale = ls tree long all level   # Aufruf: lstlale 3 (entspricht: ls --tree --long --all --level 3 )
      alias lstle='lst --level'       # lstle = ls tree level              # Aufruf: lstle 3   (entspricht: ls --tree --level 3)

      # lsblk - list block devices
      alias lsblku='lsblk -o NAME,MAJ:MIN,UUID,RM,SIZE,FSTYPE,RO,TYPE,MOUNTPOINTS' # u.a. mit UUID und FSTYPE
      alias lsblkf='lsblk --fs --paths' # u.a. mit: filesystem info, UUID und full device paths

      # cat -> bat # concatenate files and print on the standard output
      if [[ $(command -v bat) ]]; then
          alias cat='bat --plain' # --force-colorization
          alias catp='cat --paging=never' # --force-colorization
          alias catn='bat --number' # --force-colorization
          alias catf='bat --style="full"' # --force-colorization
      fi

# for install via 'archinstall_autoBash'
- name: All settings misc - Bashrc - custom alias definitions - alias rollback script - archinstall_autoBash (User, all)
  tags: shellrc
  ansible.builtin.blockinfile:
    path: "/home/{{ env_user }}/.bashrc"
    backup: false
    marker: "### {mark} 'rollback' - ANSIBLE MANAGED BLOCK ###"
    block: |
      # --------------------------------------------
      # alias rollback script - archinstall_autoBash
      # --------------------------------------------
      alias rollback='/usr/bin/rollback.sh'
  when:
    - archinstall_autobash.stat.exists # if installed via 'archinstall_autoBash'
    - rollback_script.stat.exists # if rollback script exists (installed via 'archinstall_autoBash' + systemd-boot + snapper/snapper-rollback)

# for EndeavourOS installation
- name: All settings misc - Bashrc - custom alias definitions - alias rollback script - EndeavourOS (User, all)
  tags: shellrc
  ansible.builtin.blockinfile:
    path: "/home/{{ env_user }}/.bashrc"
    backup: false
    marker: "### {mark} 'rollback eos' - ANSIBLE MANAGED BLOCK ###"
    block: |
      # -----------------------------------
      # alias rollback script - EndeavourOS
      # -----------------------------------
      alias rollback='/usr/bin/rollback_eos.sh'
  when:
    - not archinstall_autobash.stat.exists # if not installed via 'archinstall_autoBash'
    - rollback_eos_script.stat.exists # if rollback script exists (EndeavourOS + systemd-boot + snapper/snapper-rollback)

- name: All settings misc - Bashrc - custom alias definitions - snapper snapshot after snapper-rollback (User, all)
  tags: shellrc
  ansible.builtin.blockinfile:
    path: "/home/{{ env_user }}/.bashrc"
    backup: false
    marker: "### {mark} 'snapper snapshot' - ANSIBLE MANAGED BLOCK ###"
    block: |
      # -----------------------------------------------
      # alias snapper snapshot after (snapper-)rollback
      # -----------------------------------------------
      # snapper-rollback - create snapshot
      if [[ $(command -v snapper-rollback) ]]; then
        alias snapshot='sudo snapper list && echo -e "\nsudo snapper -c root create -c number --description \"after snapper-rollback x\"\n"'
      fi

- name: All settings misc - Bashrc - custom alias definitions - mount pCloud (User, all)
  tags: shellrc
  ansible.builtin.blockinfile:
    path: "/home/{{ env_user }}/.bashrc"
    backup: false
    marker: "### {mark} 'mount pCloud' - ANSIBLE MANAGED BLOCK ###"
    block: |
      # -----------------------
      # mount pCloud via rclone
      # -----------------------
      alias pcloudmnt='${HOME}/.local/bin/rclone_pCloud-Mnt.sh'

- name: All settings misc - Bashrc - custom alias definitions - pip install requirements.txt (User, all)
  tags: shellrc
  ansible.builtin.blockinfile:
    path: "/home/{{ env_user }}/.bashrc"
    backup: false
    marker: "### {mark} 'pip - requirements.txt' - ANSIBLE MANAGED BLOCK ###"
    block: |
      # -------------------------------------
      # pip install requirements.txt (--user)
      # -------------------------------------
      # find all python_pip_requirements.txt files in ansible_workstation folders and install them
      if [[ $(command -v pip) ]]; then
        alias inpipr='find $HOME -path "$HOME/*/ansible_workstation/*" -type f -name "python_pip_requirements.txt" -exec pip install --user -r {} \;'
      fi

- name: All settings misc - Bashrc - custom alias definitions - direnv for uv init (User, all)
  tags: shellrc
  ansible.builtin.blockinfile:
    path: "/home/{{ env_user }}/.bashrc"
    backup: false
    marker: "### {mark} 'direnv for uv init' - ANSIBLE MANAGED BLOCK ###"
    block: |
      # ------------------
      # direnv for uv init
      # ------------------
      # if 'uv' is installed, create a .envrc file containing/adding 'layout uv'
      if [[ $(command -v uv) ]]; then
        alias direnvuv='if [[ ! -f .envrc ]]; then touch .envrc; fi && if [[ ! $(grep 'layout uv' .envrc) ]]; then echo "layout uv" >> .envrc; fi'
      fi

- name: All settings misc - Bashrc - custom alias definitions - tasks of ansible playbook using 'tags' (User, all)
  tags: shellrc
  ansible.builtin.blockinfile:
    path: "/home/{{ env_user }}/.bashrc"
    backup: false
    marker: "### {mark} 'ansible playbook tags' - ANSIBLE MANAGED BLOCK ###"
    block: |
      # -------------------------------------------------------
      # execute selected tasks of ansible playbook using 'tags'
      # -------------------------------------------------------
      # - 'shellrc': create / update shell conf (e.g. .bashrc, .zshrc)
      alias upshellrc='${HOME}/.local/bin/ansible_update-by-tag.sh shellrc'
      # - 'vimrc': create / update vim conf + plugins
      alias upvimrc='${HOME}/.local/bin/ansible_update-by-tag.sh vimrc'
      # - 'nnnplugs': create / update 'nnn' plugins + xterm conf for nnn-peview-tui
      alias upnnnplugs='${HOME}/.local/bin/ansible_update-by-tag.sh nnnplugs'
      # - 'nvm' (node version manager): create / update + install current node version
      alias upnvm='${HOME}/.local/bin/ansible_update-by-tag.sh upnvm'

- name: All settings misc - Bashrc - custom alias definitions - 'zoxide' (User, all)
  tags: shellrc
  ansible.builtin.blockinfile:
    path: "/home/{{ env_user }}/.bashrc"
    backup: false
    marker: "### {mark} 'zoxide' - ANSIBLE MANAGED BLOCK ###"
    block: |
      # -------------------------
      # zoxide ('cd' replacement)
      # -------------------------
      # - zoxide - A smarter cd command for your terminal (? siehe auch unten; z = function ?)
      if [[ $(command -v zoxide) ]]; then
        alias cd='z'
        alias cdi='zi' # cd with interactive selection (using fzf)
      fi
  # when:
  #   - ansible_distribution in ["Archlinux"]

- name: All settings misc - Bashrc - custom alias definitions - 'fastfetch' (User, all)
  tags: shellrc
  ansible.builtin.blockinfile:
    path: "/home/{{ env_user }}/.bashrc"
    backup: false
    marker: "### {mark} 'fastfetch' - ANSIBLE MANAGED BLOCK ###"
    block: |
      # ----------------------------------
      # fastfetch ('neofetch' replacement)
      # ----------------------------------
      # - use a small icon
      if [[ $(command -v fastfetch) ]]; then
        alias fastfetch='fastfetch --logo small'
      fi
  when:
    - ansible_distribution in ["Archlinux"]

- name: All settings misc - Bashrc - Insert/Update additional paths and config - nvm (User, all)
  tags: shellrc
  ansible.builtin.blockinfile:
    path: "/home/{{ env_user }}/.bashrc"
    backup: false
    marker: "### {mark} 'nvm' - ANSIBLE MANAGED BLOCK ###"
    block: |
      # --------------------------
      # nvm (Node Version Manager)
      # --------------------------
      # https://github.com/nvm-sh/nvm
      # https://linuxize.com/post/how-to-install-node-js-on-ubuntu-22-04/
      #
      export NVM_DIR="$HOME/.nvm"
      [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"  # This loads nvm
      [ -s "$NVM_DIR/bash_completion" ] && \. "$NVM_DIR/bash_completion"  # This loads nvm bash_completion

- name: All settings misc - Bashrc - Insert/Update additional paths and config - vim (User, all)
  tags: shellrc
  ansible.builtin.blockinfile:
    path: "/home/{{ env_user }}/.bashrc"
    backup: false
    marker: "### {mark} 'vim' ANSIBLE MANAGED BLOCK ###"
    block: |
      # ------------------------------
      # vim als Standard Editor setzen
      # -------------------------------
      export VISUAL=vim
      export EDITOR="${VISUAL}"
      export SUDO_EDITOR=rvim

- name: All settings misc - Bashrc - Insert/Update additional paths and config - user-bin (User, all)
  tags: shellrc
  ansible.builtin.blockinfile:
    path: "/home/{{ env_user }}/.bashrc"
    backup: false
    marker: "### {mark} 'user-bin' ANSIBLE MANAGED BLOCK ###"
    block: |
      # ------------------------------------------
      # Benutzer-bin Verzeichnis an PATH anhängen:
      # ------------------------------------------
      export PATH=~/.local/bin:$PATH

- name: All settings misc - Bashrc - Insert/Update additional paths and config - pyenv (User, Debian)
  tags: shellrc
  ansible.builtin.blockinfile:
    path: "/home/{{ env_user }}/.bashrc"
    backup: false
    marker: "### {mark} 'pyenv' ANSIBLE MANAGED BLOCK ###"
    block: |
      # -----
      # pyenv
      # -----
      # https://ostechnix.com/pyenv-python-version-management-made-easier/
      #
      export PATH="$HOME/.pyenv/bin:$PATH"
      eval "$(pyenv init -)"
      eval "$(pyenv virtualenv-init -)"
  when:
    - ansible_distribution in ["Debian"]

# - name: All settings misc - Bashrc - initial command 'pyenv init' - pyenv (User, Arch)
#  tags: shellrc
#  become: true
#  become_user: "{{ env_user }}"
#  ansible.builtin.shell:
#    cmd: pyenv init >/dev/null && touch /home/{{ env_user }}/.pyenvinitExecuted
# args:
#    creates: /home/{{ env_user }}/.pyenvinitExecuted
#  ignore_errors: true
#  when:
#    - ansible_distribution in ["Archlinux"]

- name: All settings misc - Bashrc - Insert/Update additional paths and config - pyenv (User, Arch)
  tags: shellrc
  ansible.builtin.blockinfile:
    path: "/home/{{ env_user }}/.bashrc"
    backup: false
    marker: "### {mark} 'pyenv' ANSIBLE MANAGED BLOCK ###"
    block: |
      # -----
      # pyenv
      # -----
      export PYENV_ROOT="$HOME/.pyenv"
      command -v pyenv >/dev/null || export PATH="$PYENV_ROOT/bin:$PATH"
      eval "$(pyenv init -)"
      eval "$(pyenv virtualenv-init -)"
  when:
    - ansible_distribution in ["Archlinux"]

- name: All settings misc - Bashrc - Insert/Update additional paths and config - uv (User, all)
  tags: shellrc
  ansible.builtin.blockinfile:
    path: "/home/{{ env_user }}/.bashrc"
    backup: false
    marker: "### {mark} 'uv' ANSIBLE MANAGED BLOCK ###"
    block: |
      # -------------------------
      # uv - shell autocompletion
      # -------------------------
      eval "$(uv generate-shell-completion bash)"
      eval "$(uvx --generate-shell-completion bash)"

- name: All settings misc - Bashrc - Insert/Update additional paths and config - zoxide (User, all)
  tags: shellrc
  ansible.builtin.blockinfile:
    path: "/home/{{ env_user }}/.bashrc"
    backup: false
    marker: "### {mark} 'zoxide' ANSIBLE MANAGED BLOCK ###"
    block: |
      # ------
      # zoxide
      # ------
      # do AFTER init of 'starship'
      eval "$(zoxide init bash)"
  # when:
  #   - ansible_distribution in ["Archlinux"]

# https://wiki.archlinux.org/title/Systemd/User#PATH
- name: All settings misc - Bashrc - systemd user import-environment (User, all)
  tags: shellrc
  ansible.builtin.blockinfile:
    path: "/home/{{ env_user }}/.bashrc"
    backup: false
    marker: "### {mark} 'systemd user' ANSIBLE MANAGED BLOCK ###"
    block: |
      # -------------------------------
      # systemd user import-environment
      # -------------------------------
      systemctl --user import-environment PATH

# https://github.com/direnv/direnv/blob/master/docs/hook.md
- name: All settings misc - Bashrc - direnv hook (User, all)
  tags: shellrc
  ansible.builtin.blockinfile:
    path: "/home/{{ env_user }}/.bashrc"
    backup: false
    marker: "### {mark} 'direnv hook' ANSIBLE MANAGED BLOCK ###"
    block: |
      # -----------
      # direnv hook
      # -----------
      eval "$(direnv hook bash)"

# --------
# ### root
- name: All settings misc - Bashrc - check status (root, all)
  tags: shellrc
  ansible.builtin.stat:
    path: "/root/.bashrc"
  register: stat_bashrc_root

- name: All settings misc - Bashrc - create (root, all)
  tags: shellrc
  ansible.builtin.file:
    path: "/root/.bashrc"
    state: touch
    mode: "0644"
  when:
    - not stat_bashrc_root.stat.exists

- name: All settings misc - Bashrc - Insert/Update additional paths and config - starship shell prompt (root, all)
  tags: shellrc
  ansible.builtin.blockinfile:
    path: "/root/.bashrc"
    backup: true
    marker: "### {mark} 'starship shell prompt' ANSIBLE MANAGED BLOCK ###"
    block: |
      # -------------------------------------------
      # starship shell prompt - Add the init script
      # -------------------------------------------
      eval "$(starship init bash)"

- name: All settings misc - Bashrc - Insert/Update additional paths and config (root, all)
  tags: shellrc
  ansible.builtin.blockinfile:
    path: "/root/.bashrc"
    backup: false
    marker: "### {mark} 'vim' ANSIBLE MANAGED BLOCK ###"
    block: |
      # ------------------------------
      # vim als Standard Editor setzen
      # -------------------------------
      export VISUAL=vim
      export EDITOR="${VISUAL}"
      export SUDO_EDITOR=rvim

# #######################################
# ### zsh - add additional Paths + Config
# #######################################
# - global wäre: /etc/zshrc   # https://linuxconfig.org/zsh-shell-installation-and-configuration-on-linux

# --------
# ### user
- name: All settings misc - Zshrc - check status .zshrc (User, all)
  tags: shellrc
  ansible.builtin.stat:
    path: "/home/{{ env_user }}/.zshrc"
  register: zshrc_user

- name: All settings misc - Zshrc - backup existing .zshrc (User, all)
  tags: shellrc
  ansible.builtin.copy:
    src: "/home/{{ env_user }}/.zshrc"
    dest: "/home/{{ env_user }}/.zshrc.old"
    owner: "{{ env_user }}"
    group: "{{ env_user }}"
    mode: u=rw,g=r,o=r
    backup: true
  when:
    - zshrc_user.stat.exists

- name: All settings misc - Zshrc - delete existing .zshrc (User, all)
  tags: shellrc
  ansible.builtin.file:
    path: "/home/{{ env_user }}/.zshrc"
    state: absent
  when:
    - zshrc_user.stat.exists

- name: All settings misc - Zshrc - Insert/Update additional paths and config - starship shell prompt (User,all)
  tags: shellrc
  ansible.builtin.blockinfile:
    path: "/home/{{ env_user }}/.zshrc"
    backup: true
    create: true
    owner: "{{ env_user }}"
    group: "{{ env_user }}"
    mode: u=rw,g=r,o=r
    marker: "### {mark} 'starship shell prompt' ANSIBLE MANAGED BLOCK ###"
    block: |
      # -------------------------------------------
      # starship shell prompt - Add the init script
      # -------------------------------------------
      eval "$(starship init zsh)"

- name: All settings misc - Zshrc - Insert initial custom config in .zshrc (User, all)
  tags: shellrc
  ansible.builtin.blockinfile:
    path: "/home/{{ env_user }}/.zshrc"
    backup: false
    marker: "### {mark} 'custom zsh config' ANSIBLE MANAGED BLOCK ###"
    block: |
      # -------------------------
      # custom initial zsh config
      # -------------------------
      # Options section
      # setopt interactivecomments
      setopt correct                                            # Auto correct mistakes
      setopt extendedglob                                       # Extended globbing. Allows using regular expressions with *
      setopt nocaseglob                                         # Case insensitive globbing
      setopt rcexpandparam                                      # Array expension with parameters
      setopt nocheckjobs                                        # Don't warn about running processes when exiting
      setopt numericglobsort                                    # Sort filenames numerically when it makes sense
      setopt nobeep                                             # No beep
      setopt appendhistory                                      # Immediately append history instead of overwriting
      setopt histignorealldups                                  # If a new command is a duplicate, remove #the older one
      setopt autocd                                             # if only directory path is entered, cd #there.
      setopt inc_append_history                                 # save commands are added to the history #immediately, otherwise only when shell exits.
      setopt histignorespace                                    # Don't save commands that start with #space

      zstyle ':completion:*' matcher-list 'm:{a-zA-Z}={A-Za-z}' # Case insensitive tab completion
      zstyle ':completion:*' list-colors "${(s.:.)LS_COLORS}"   # Colored completion (different colors for dirs/files/etc)
      zstyle ':completion:*' rehash true                        # automatically find new executables in path
      # Speed up completions
      zstyle ':completion:*' accept-exact '*(N)'
      zstyle ':completion:*' use-cache on
      zstyle ':completion:*' cache-path ~/.zsh/cache
      HISTFILE=~/.zhistory
      HISTSIZE=10000
      SAVEHIST=10000
      WORDCHARS=${WORDCHARS//\/[&.;]}                            # Don't consider certain characters part of the word

      # Keybindings section
      bindkey -e                                                 # use Emacs mode
      bindkey '^[[7~' beginning-of-line                          # Home key
      bindkey '^[[H' beginning-of-line                           # Home key
      if [[ "${terminfo[khome]}" != "" ]]; then
        bindkey "${terminfo[khome]}" beginning-of-line           # [Home] - Go to beginning of line
      fi
      bindkey '^[[8~' end-of-line                                # End key
      bindkey '^[[F' end-of-line                                 # End key
      if [[ "${terminfo[kend]}" != "" ]]; then
        bindkey "${terminfo[kend]}" end-of-line                  # [End] - Go to end of line
      fi
      bindkey '^[[2~' overwrite-mode                             # Insert key
      bindkey '^[[3~' delete-char                                # Delete key
      bindkey '^[[C'  forward-char                               # Right key
      bindkey '^[[D'  backward-char                              # Left key
      bindkey '^[[5~' history-beginning-search-backward          # Page up key
      bindkey '^[[6~' history-beginning-search-forward                # Page down key

      # Navigate words with ctrl+arrow keys
      bindkey '^[Oc' forward-word                                #
      bindkey '^[Od' backward-word                               #
      bindkey '^[[1;5D' backward-word                            #
      bindkey '^[[1;5C' forward-word                             #
      bindkey '^H' backward-kill-word                            # delete previous word with ctrl+backspace
      bindkey '^[[Z' undo                                        # Shift+tab undo last action

      # Theming section
      autoload -Uz compinit promptinit colors zcalc
      compinit -d
      promptinit
      colors

      # Color man pages
      export LESS_TERMCAP_mb=$'\E[01;32m'
      export LESS_TERMCAP_md=$'\E[01;32m'
      export LESS_TERMCAP_me=$'\E[0m'
      export LESS_TERMCAP_se=$'\E[0m'
      export LESS_TERMCAP_so=$'\E[01;47;34m'
      export LESS_TERMCAP_ue=$'\E[0m'
      export LESS_TERMCAP_us=$'\E[01;36m'
      export LESS=-R

      # Plugins section: Enable fish style features
      # Use syntax highlighting
      if [[ -r /usr/share/zsh/plugins/zsh-autosuggestions/zsh-autosuggestions.zsh ]]; then
        source /usr/share/zsh/plugins/zsh-autosuggestions/zsh-autosuggestions.zsh
      fi
      # Use autosuggestions
      if [[ -r /usr/share/zsh/plugins/zsh-syntax-highlighting/zsh-syntax-highlighting.zsh ]]; then
          source /usr/share/zsh/plugins/zsh-syntax-highlighting/zsh-syntax-highlighting.zsh
      fi
      # Use history substring search
      if [[ -r /usr/share/zsh/plugins/zsh-history-substring-search/zsh-history-substring-search.zsh ]]; then
          source /usr/share/zsh/plugins/zsh-history-substring-search/zsh-history-substring-search.zsh

          # bind UP and DOWN arrow keys to history substring search
          zmodload zsh/terminfo
          bindkey "$terminfo[kcuu1]" history-substring-search-up
          bindkey "$terminfo[kcud1]" history-substring-search-down
          bindkey '^[[A' history-substring-search-up
          bindkey '^[[B' history-substring-search-down
      fi

      # Offer to install missing package if command is not found
      if [[ -r /usr/share/zsh/functions/command-not-found.zsh ]]; then
          source /usr/share/zsh/functions/command-not-found.zsh
          export PKGFILE_PROMPT_INSTALL_MISSING=1
      fi

      # File and Dir colors for ls and other outputs
      export LS_OPTIONS='--color=auto'
      eval "$(dircolors -b)"

      # Alias section
      alias ls='ls $LS_OPTIONS'
      alias cp="cp -i"                                                # Confirm before overwriting something
      alias df='df -h'                                                # Human-readable sizes
      alias free='free -m'                                            # Show sizes in MB

# Übernommen + anpgepasst aus manjaro-zsh-config (/usr/share/zsh/manjaro-zsh-config)
# Anm.: zsh ist bei Manjaro die Standardshell und entsprechend vorkonfiguriert
# https://unix.stackexchange.com/questions/33255/how-to-define-and-load-your-own-shell-function-in-zsh
# https://zplugin.readthedocs.io/en/latest/zsh-plugin-standard/
#
# https://stackoverflow.com/questions/65020310/how-to-copy-file-content-to-another-file-in-ansible-without-overwriting-the-seco
# https://cloudlinuxtech.com/zsh-syntax-highlighting-autosuggestions/#How_to_install_the_zsh-syntax-highlighting_package_in_Linux
# - name: All settings misc - Zshrc - Insert 'files/custom-zsh-config' in .zshrc (User, all)
#   tags: shellrc
#   ansible.builtin.blockinfile:
#     path: "/home/{{ env_user }}/.zshrc"
#     backup: false
#     marker: "### {mark} 'custom zsh config' ANSIBLE MANAGED BLOCK ###"
#     block: |
#       # -----------------
#       # custom zsh config
#       # -----------------
#       "{{ lookup('file', 'files/custom-zsh-config') }}"
#
# Zeichenfolge '"<feff>' wurde vor Inhalt aus 'files/custom-zsh-config' eingefügt
# U+FEFF was called a ZERO WIDTH NO-BREAK SPACE
# Also, a quick trip to Wikipedia told us about the actual uses for U+FEFF, more commonly known as Byte order mark or BOM
# Datei 'files/custom-zsh-config' war als UTF-8 mit BOM --> als 'normales' UTF-8 File ohne BOM gespeichert
# https://www.freecodecamp.org/news/a-quick-tale-about-feff-the-invisible-character-cd25cd4630e7/
# https://www.fileformat.info/info/unicode/char/feff/index.htm
#
# danach wurde noch ein '"' vor den Inhalt aus der Datei gesetzt. entfernt:
# - name: All settings misc - Zshrc -  Delete '"' at beginnning of insterted text form 'custom-zsh-config' in .zshrc (User, all)
#   tags: shellrc
#   ansible.builtin.replace:
#     path: "/home/{{ env_user }}/.zshrc"
#     regexp: '^"#'
#     replace: "##"


- name: All settings misc - Zshrc - additional EXPORTS - colored password prompt (User, all)
  tags: shellrc
  ansible.builtin.blockinfile:
    path: "/home/{{ env_user }}/.zshrc"
    backup: false
    marker: "### {mark} 'additional EXPORTS' ANSIBLE MANAGED BLOCK ###"
    block: |
      # ------------------
      # additional EXPORTS
      # ------------------

      # Colored password prompt
      # https://wiki.archlinux.org/title/Sudo#Colored_password_prompt
      export SUDO_PROMPT="$(tput setaf 1 bold)[sudo]$(tput sgr0) password for $(tput setaf 6)%p$(tput sgr0): "

- name: All settings misc - Zshrc - custom alias definitions (User, all)
  tags: shellrc
  ansible.builtin.blockinfile:
    path: "/home/{{ env_user }}/.zshrc"
    backup: false
    marker: "### {mark} 'custom alias definitions' ANSIBLE MANAGED BLOCK ###"
    block: |
      # ------------------------
      # custom alias definitions
      # ------------------------

      # KITTY - alias to be able to use kitty features when connecting to remote servers (e.g use tmux on remote server)
      alias kssh="kitty +kitten ssh"

      # grep
      alias grep='grep --color=auto'

      # ls -> eza oder exa - list directory contents
      if [[ $(command -v eza) ]]; then
          alias ls='eza --color=auto --icons --group --time-style=long-iso --group-directories-first'
          # '--group' und '--time-style' nur bei '-l'; dann schon dabei
      elif [[ $(command -v exa) ]]; then
          alias ls='exa --color=auto --icons --group --time-style=long-iso --group-directories-first'
          # '--group' und '--time-style' nur bei '-l'; dann schon dabei
      else
          alias ls='ls --color=auto --group-directories-first'
      fi

      alias ll='ls -la --ignore-glob ..'            # show long listing of all except ".."
      alias l='ls -la --ignore-glob .?*'            # show long listing but no hidden dotfiles except "." (rekursiv bis 1. Unterverzeichnis, mit dessen Inhalt)
      # tree-view:
      alias lst='ls --tree'           # lst = ls tree
      alias lstl='lst --long'         # lstl = ls tree long
      alias lstla='lstl --all'        # lstla = ls tree long all
      alias lstlale='lstla --level'   # lstlale = ls tree long all level   # Aufruf: lstlale 3 (entspricht: ls --tree --long --all --level 3 )
      alias lstle='lst --level'       # lstle = ls tree level              # Aufruf: lstle 3   (entspricht: ls --tree --level 3)

      # lsblk - list block devices
      alias lsblku='lsblk -o NAME,MAJ:MIN,UUID,RM,SIZE,FSTYPE,RO,TYPE,MOUNTPOINTS' # u.a. mit UUID und FSTYPE
      alias lsblkf='lsblk --fs --paths' # u.a. mit: filesystem info, UUID und full device paths

      # cat -> bat # concatenate files and print on the standard output
      if [[ $(command -v bat) ]]; then
          alias cat='bat --plain' # --force-colorization
          alias catp='cat --paging=never' # --force-colorization
          alias catn='bat --number' # --force-colorization
          alias catf='bat --style="full"' # --force-colorization
      fi

# for install via 'archinstall_autoBash'
- name: All settings misc - Zshrc - custom alias definitions - alias rollback script - archinstall_autoBash (User, all)
  tags: shellrc
  ansible.builtin.blockinfile:
    path: "/home/{{ env_user }}/.zshrc"
    backup: false
    marker: "### {mark} 'rollback' - ANSIBLE MANAGED BLOCK ###"
    block: |
      # --------------------------------------------
      # alias rollback script - archinstall_autoBash
      # --------------------------------------------
      alias rollback='/usr/bin/rollback.sh'
  when:
    - archinstall_autobash.stat.exists # if installed via 'archinstall_autoBash'
    - rollback_script.stat.exists # if rollback script exists (installed via 'archinstall_autoBash' + systemd-boot + snapper/snapper-rollback)

# for EndeavourOS installation
- name: All settings misc - Zshrc - custom alias definitions - alias rollback script - EndeavourOS (User, all)
  tags: shellrc
  ansible.builtin.blockinfile:
    path: "/home/{{ env_user }}/.zshrc"
    backup: false
    marker: "### {mark} 'rollback eos' - ANSIBLE MANAGED BLOCK ###"
    block: |
      # -----------------------------------
      # alias rollback script - EndeavourOS
      # -----------------------------------
      alias rollback='/usr/bin/rollback_eos.sh'
  when:
    - not archinstall_autobash.stat.exists # if EndeavourOS
    - rollback_eos_script.stat.exists # if rollback script exists (EndeavourOS + systemd-boot + snapper/snapper-rollback)

- name: All settings misc - Zshrc - custom alias definitions - snapper snapshot after snapper-rollback (User, all)
  tags: shellrc
  ansible.builtin.blockinfile:
    path: "/home/{{ env_user }}/.zshrc"
    backup: false
    marker: "### {mark} 'snapper snapshot' - ANSIBLE MANAGED BLOCK ###"
    block: |
      # -----------------------------------------------
      # alias snapper snapshot after (snapper-)rollback
      # -----------------------------------------------
      # snapper-rollback - create snapshot
      if [[ $(command -v snapper-rollback) ]]; then
        alias snapshot='sudo snapper list && echo -e "\nsudo snapper -c root create -c number --description \"after snapper-rollback x\"\n"'
      fi

- name: All settings misc - Zshrc - custom alias definitions - mount pCloud (User, all)
  tags: shellrc
  ansible.builtin.blockinfile:
    path: "/home/{{ env_user }}/.zshrc"
    backup: false
    marker: "### {mark} 'mount pCloud' - ANSIBLE MANAGED BLOCK ###"
    block: |
      # -----------------------
      # mount pCloud via rclone
      # -----------------------
      alias pcloudmnt='${HOME}/.local/bin/rclone_pCloud-Mnt.sh'

- name: All settings misc - Zshrc - custom alias definitions - pip install requirements.txt (User, all)
  tags: shellrc
  ansible.builtin.blockinfile:
    path: "/home/{{ env_user }}/.zshrc"
    backup: false
    marker: "### {mark} 'pip - requirements.txt' - ANSIBLE MANAGED BLOCK ###"
    block: |
      # -------------------------------------
      # pip install requirements.txt (--user)
      # -------------------------------------
      # find all python_pip_requirements.txt files in ansible_workstation folders and install them
      if [[ $(command -v pip) ]]; then
        alias inpipr='find $HOME -path "$HOME/*/ansible_workstation/*" -type f -name "python_pip_requirements.txt" -exec pip install --user -r {} \;'
      fi

- name: All settings misc - Zshrc - custom alias definitions - direnv for uv init (User, all)
  tags: shellrc
  ansible.builtin.blockinfile:
    path: "/home/{{ env_user }}/.zshrc"
    backup: false
    marker: "### {mark} 'direnv for uv init' - ANSIBLE MANAGED BLOCK ###"
    block: |
      # ------------------
      # direnv for uv init
      # ------------------
      # if 'uv' is installed, create a .envrc file containing/adding 'layout uv'
      if [[ $(command -v uv) ]]; then
        alias direnvuv='if [[ ! -f .envrc ]]; then touch .envrc; fi && if [[ ! $(grep '"'"'layout uv'"'"' .envrc) ]]; then echo "layout uv" >> .envrc; fi'
      fi
# oder: ... $(grep "layout uv" .envrc) ... # grep mit dopppelten Anführungszeichen, statt einfache Anführungszeichen + maskieren, ginge hier auch

- name: All settings misc - Zshrc - custom alias definitions - tasks of ansible playbook using 'tags' (User, all)
  tags: shellrc
  ansible.builtin.blockinfile:
    path: "/home/{{ env_user }}/.zshrc"
    backup: false
    marker: "### {mark} 'ansible playbook tags' - ANSIBLE MANAGED BLOCK ###"
    block: |
      # -------------------------------------------------------
      # execute selected tasks of ansible playbook using 'tags'
      # -------------------------------------------------------
      # - 'shellrc': create / update shell conf (e.g. .bashrc, .zshrc)
      alias upshellrc='${HOME}/.local/bin/ansible_update-by-tag.sh shellrc'
      # - 'vimrc': create / update vim conf + plugins
      alias upvimrc='${HOME}/.local/bin/ansible_update-by-tag.sh vimrc'
      # - 'nnnplugs': create / update 'nnn' plugins + xterm conf for nnn-peview-tui
      alias upnnnplugs='${HOME}/.local/bin/ansible_update-by-tag.sh nnnplugs'
      # - 'nvm' (node version manager): create / update + install current node version
      alias upnvm='${HOME}/.local/bin/ansible_update-by-tag.sh upnvm'

- name: All settings misc - Zshrc - custom alias definitions - 'zoxide' (User, all)
  tags: shellrc
  ansible.builtin.blockinfile:
    path: "/home/{{ env_user }}/.zshrc"
    backup: false
    marker: "### {mark} 'zoxide' - ANSIBLE MANAGED BLOCK ###"
    block: |
      # -------------------------
      # zoxide ('cd' replacement)
      # -------------------------
      # - zoxide - A smarter cd command for your terminal (? siehe auch unten; z = function ?)
      if [[ $(command -v zoxide) ]]; then
        alias cd='z'
        alias cdi='zi' # cd with interactive selection (using fzf)
      fi
  # when:
  #   - ansible_distribution in ["Archlinux"]

- name: All settings misc - Zshrc - custom alias definitions - 'fastfetch' (User, all)
  tags: shellrc
  ansible.builtin.blockinfile:
    path: "/home/{{ env_user }}/.zshrc"
    backup: false
    marker: "### {mark} 'fastfetch' - ANSIBLE MANAGED BLOCK ###"
    block: |
      # ----------------------------------
      # fastfetch ('neofetch' replacement)
      # ----------------------------------
      # - use a small icon
      if [[ $(command -v fastfetch) ]]; then
        alias fastfetch='fastfetch --logo small'
      fi
  when:
    - ansible_distribution in ["Archlinux"]

- name: All settings misc - Zshrc - Insert/Update additional paths and config - nvm (User, all)
  tags: shellrc
  ansible.builtin.blockinfile:
    path: "/home/{{ env_user }}/.zshrc"
    backup: false
    marker: "### {mark} 'nvm' - ANSIBLE MANAGED BLOCK ###"
    block: |
      # --------------------------
      # nvm (Node Version Manager)
      # --------------------------
      # https://github.com/nvm-sh/nvm
      # https://linuxize.com/post/how-to-install-node-js-on-ubuntu-22-04/
      #
      export NVM_DIR="$HOME/.nvm"
      [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"  # This loads nvm
      [ -s "$NVM_DIR/bash_completion" ] && \. "$NVM_DIR/bash_completion"  # This loads nvm bash_completion

- name: All settings misc - Zshrc - Insert/Update additional paths and config - vim (User, all)
  tags: shellrc
  ansible.builtin.blockinfile:
    path: "/home/{{ env_user }}/.zshrc"
    backup: false
    marker: "### {mark} 'vim' ANSIBLE MANAGED BLOCK ###"
    block: |
      # ------------------------------
      # vim als Standard Editor setzen
      # -------------------------------
      export VISUAL=vim
      export EDITOR="${VISUAL}"
      export SUDO_EDITOR=rvim

- name: All settings misc - Zshrc - Insert/Update additional paths and config - user-bin (User, all)
  tags: shellrc
  ansible.builtin.blockinfile:
    path: "/home/{{ env_user }}/.zshrc"
    backup: false
    marker: "### {mark} 'user-bin' ANSIBLE MANAGED BLOCK ###"
    block: |
      # ------------------------------------------
      # Benutzer-bin Verzeichnis an PATH anhängen:
      # ------------------------------------------
      export PATH=~/.local/bin:$PATH

- name: All settings misc - Zshrc - Insert/Update additional paths and config - pyenv (User, Debian)
  tags: shellrc
  ansible.builtin.blockinfile:
    path: "/home/{{ env_user }}/.zshrc"
    backup: false
    marker: "### {mark} 'pyenv' ANSIBLE MANAGED BLOCK ###"
    block: |
      # -----
      # pyenv
      # -----
      # https://ostechnix.com/pyenv-python-version-management-made-easier/
      #
      export PATH="$HOME/.pyenv/bin:$PATH"
      eval "$(pyenv init -)"
      eval "$(pyenv virtualenv-init -)"
  when:
    - ansible_distribution in ["Debian"]

# - name: All settings misc - Zshrc - initial command 'pyenv init' - pyenv (User, Arch)
#  tags: shellrc
#  become: true
#  become_user: "{{ env_user }}"
#  ansible.builtin.shell:
#    cmd: pyenv init >/dev/null && touch /home/{{ env_user }}/.pyenvinitExecuted
#  args:
#    creates: /home/{{ env_user }}/.pyenvinitExecuted
#  ignore_errors: true
#  when:
#    - ansible_distribution in ["Archlinux"]

- name: All settings misc - Zshrc - Insert/Update additional paths and config - pyenv (User, Arch)
  tags: shellrc
  ansible.builtin.blockinfile:
    path: "/home/{{ env_user }}/.zshrc"
    backup: false
    marker: "### {mark} 'pyenv' ANSIBLE MANAGED BLOCK ###"
    block: |
      # -----
      # pyenv
      # -----
      export PYENV_ROOT="$HOME/.pyenv"
      command -v pyenv >/dev/null || export PATH="$PYENV_ROOT/bin:$PATH"
      eval "$(pyenv init -)"
      eval "$(pyenv virtualenv-init -)"
  when:
    - ansible_distribution in ["Archlinux"]

- name: All settings misc - Zshrc - Insert/Update additional paths and config - uv (User, all)
  tags: shellrc
  ansible.builtin.blockinfile:
    path: "/home/{{ env_user }}/.zshrc"
    backup: false
    marker: "### {mark} 'uv' ANSIBLE MANAGED BLOCK ###"
    block: |
      # -------------------------
      # uv - shell autocompletion
      # -------------------------
      eval "$(uv generate-shell-completion zsh)"
      eval "$(uvx --generate-shell-completion zsh)"

- name: All settings misc - Zshrc - Insert/Update additional paths and config - zoxide (User, all)
  tags: shellrc
  ansible.builtin.blockinfile:
    path: "/home/{{ env_user }}/.zshrc"
    backup: false
    marker: "### {mark} 'zoxide' ANSIBLE MANAGED BLOCK ###"
    block: |
      # ------
      # zoxide
      # ------
      # do AFTER init of 'starship'
      eval "$(zoxide init zsh)"
  # when:
  #   - ansible_distribution in ["Archlinux"]

- name: All settings misc - Zshrc - Insert/Update additional paths and conig - tilix - vte config (User, all)
  tags: shellrc
  ansible.builtin.blockinfile:
    path: "/home/{{ env_user }}/.zshrc"
    backup: false
    marker: "### {mark} 'tilix' ANSIBLE MANAGED BLOCK ###"
    block: |
      # ------------------
      # tilix - vte config
      # ------------------
      # * https://gnunn1.github.io/tilix-web/manual/vteconfig/

      if ([ $TILIX_ID ] || [ $VTE_VERSION ]) && [[ -e /etc/profile.d/vte.sh ]]; then
        source /etc/profile.d/vte.sh
      fi

- name: All settings misc - Zshrc - Insert/Update additional paths and config - nnn (User, all)
  tags: shellrc
  ansible.builtin.blockinfile:
    path: "/home/{{ env_user }}/.zshrc"
    backup: false
    marker: "### {mark} 'nnn' ANSIBLE MANAGED BLOCK ###"
    block: |
      # ---------------------------
      # 'nnn' terminal file manager
      # ---------------------------
      # * https://github.com/jarun/nnn

      export NNN_FIFO='/tmp/nnn.fifo'
      export NNN_TERMINAL='xterm'
      export NNN_PLUG='d:diffs;o:fzopen;j:autojump;p:preview-tui;r:pdfread;u:getplugs;v:imgview'

      alias n='nnn_cdonquit -deiU -P p'
      # detailed; open txt in $VISUAL; show file info bar; show user+group; start Plugin 'p' (-> preview-tui)

      # --- cd on quit:
      # * https://github.com/jarun/nnn/wiki/Basic-use-cases#configure-cd-on-quit
      # * https://github.com/jarun/nnn/blob/master/misc/quitcd/quitcd.bash_sh_zsh

      nnn_cdonquit ()
      {
          # Block nesting of nnn in subshells
          [ "${NNNLVL:-0}" -eq 0 ] || {
              echo "nnn is already running"
              return
          }

          # The behaviour is set to cd on quit (nnn checks if NNN_TMPFILE is set)
          # If NNN_TMPFILE is set to a custom path, it must be exported for nnn to
          # see. To cd on quit only on ^G, remove the "export" and make sure not to
          # use a custom path, i.e. set NNN_TMPFILE *exactly* as follows:
          NNN_TMPFILE="${XDG_CONFIG_HOME:-$HOME/.config}/nnn/.lastd"             # only 'cd on quit' when ^G
          # export NNN_TMPFILE="${XDG_CONFIG_HOME:-$HOME/.config}/nnn/.lastd"    # always 'cd on quit'

          # Unmask ^Q (, ^V etc.) (if required, see `stty -a`) to Quit nnn
          # stty start undef
          # stty stop undef
          # stty lwrap undef
          # stty lnext undef

          # The command builtin allows one to alias nnn to n, if desired, without
          # making an infinitely recursive alias
          command nnn "$@"

          [ ! -f "$NNN_TMPFILE" ] || {
              . "$NNN_TMPFILE"
              rm -f -- "$NNN_TMPFILE" > /dev/null
          }
      }

# https://wiki.archlinux.org/title/Systemd/User#PATH
- name: All settings misc - Zshrc - systemd user import-environment (User, all)
  tags: shellrc
  ansible.builtin.blockinfile:
    path: "/home/{{ env_user }}/.zshrc"
    backup: false
    marker: "### {mark} 'systemd user' ANSIBLE MANAGED BLOCK ###"
    block: |
      # -------------------------------
      # systemd user import-environment
      # -------------------------------
      systemctl --user import-environment PATH

# https://github.com/direnv/direnv/blob/master/docs/hook.md
- name: All settings misc - Zshrc - direnv hook (User, all)
  tags: shellrc
  ansible.builtin.blockinfile:
    path: "/home/{{ env_user }}/.zshrc"
    backup: false
    marker: "### {mark} 'direnv hook' ANSIBLE MANAGED BLOCK ###"
    block: |
      # -----------
      # direnv hook
      # -----------
      eval "$(direnv hook zsh)"

# --------
# ### root
- name: All settings misc - Zshrc - check status (root, all)
  tags: shellrc
  ansible.builtin.stat:
    path: "/root/.zshrc"
  register: stat_bashrc_root

- name: All settings misc - Zshrc - create (root, all)
  ansible.builtin.file:
    path: "/root/.zshrc"
    state: touch
    mode: "0644"
  when:
    - not stat_bashrc_root.stat.exists

- name: All settings misc - Zshrc - Insert/Update additional paths and config - starship shell prompt (root, all)
  tags: shellrc
  ansible.builtin.blockinfile:
    path: "/root/.zshrc"
    backup: true
    marker: "### {mark} 'starship shell prompt' ANSIBLE MANAGED BLOCK ###"
    block: |
      # -------------------------------------------
      # starship shell prompt - Add the init script
      # -------------------------------------------
      eval "$(starship init zsh)"

- name: All settings misc - Zshrc - Insert/Update additional paths and config (root, all)
  tags: shellrc
  ansible.builtin.blockinfile:
    path: "/root/.zshrc"
    backup: false
    marker: "### {mark} 'vim' ANSIBLE MANAGED BLOCK ###"
    block: |
      # ------------------------------
      # vim als Standard Editor setzen
      # -------------------------------
      export VISUAL=vim
      export EDITOR="${VISUAL}"
      export SUDO_EDITOR=rvim

# ######################################################
# ### PowerShell_profile - add additional Paths + Config
# ######################################################

- name: All settings misc - PowerShell_profile - Create folder (env_user, all)
  tags: shellrc
  become: true
  become_user: "{{ env_user }}"
  ansible.builtin.file:
    path: "/home/{{ env_user }}/.config/powershell"
    state: directory
    mode: '0755'

- name: All settings misc - PowerShell_profile - Create folder (root, all)
  tags: shellrc
  ansible.builtin.file:
    path: "/root/.config/powershell"
    state: directory
    mode: '0755'

- name: All settings misc - PowerShell_profile - Starship init (env_user, all)
  tags: shellrc
  become: true
  become_user: "{{ env_user }}"
  ansible.builtin.blockinfile:
    path: "/home/{{ env_user }}/.config/powershell/Microsoft.PowerShell_profile.ps1"
    create: true
    backup: false
    marker: "### {mark} 'starship shell prompt' ANSIBLE MANAGED BLOCK ###"
    block: |
      # -------------------------------------------
      # starship shell prompt - Add the init script
      # -------------------------------------------
      Invoke-Expression (&starship init powershell)
    mode: '0755'

# https://learn.microsoft.com/en-us/dotnet/api/system.globalization.cultureinfo.currentculture?view=dotnet-plat-ext-7.0
# globaler und betrifft die gesamte Anwendung oder den Prozess.
# [System.Globalization.CultureInfo]::CurrentCulture = [System.Globalization.CultureInfo]::CreateSpecificCulture('de-DE')
#
# Einstellung gilt nur für den aktuellen Thread.
# In PowerShell betrifft dies normalerweise nur die aktuelle Sitzung oder den aktuellen Thread, in dem der Befehl ausgeführt wird.
# Möglichkeit 1: [System.Threading.Thread]::CurrentThread.CurrentCulture = [System.Globalization.CultureInfo]::CreateSpecificCulture('de-DE')
# Möglichkeit 2 (s.u.): [System.Threading.Thread]::CurrentThread.CurrentCulture = 'de-DE'

- name: All settings misc - PowerShell_profile - Set CurrentCulture (env_user, all)
  tags: shellrc
  become: true
  become_user: "{{ env_user }}"
  ansible.builtin.blockinfile:
    path: "/home/{{ env_user }}/.config/powershell/Microsoft.PowerShell_profile.ps1"
    create: true
    backup: false
    marker: "### {mark} 'CurrentCulture' ANSIBLE MANAGED BLOCK ###"
    block: |
      # -------------------------------
      # CurrentCulture - Set to 'de-DE'
      # -------------------------------
      [System.Threading.Thread]::CurrentThread.CurrentCulture = 'de-DE'
    mode: '0755'

- name: All settings misc - PowerShell_profile - Starship init (root, all)
  tags: shellrc
  ansible.builtin.blockinfile:
    path: "/root/.config/powershell/Microsoft.PowerShell_profile.ps1"
    create: true
    backup: false
    marker: "### {mark} 'starship shell prompt' ANSIBLE MANAGED BLOCK ###"
    block: |
      # -------------------------------------------
      # starship shell prompt - Add the init script
      # -------------------------------------------
      Invoke-Expression (&starship init powershell)
    mode: '0755'

- name: All settings misc - PowerShell_profile - Starship init (root, all)
  tags: shellrc
  ansible.builtin.blockinfile:
    path: "/root/.config/powershell/Microsoft.PowerShell_profile.ps1"
    create: true
    backup: false
    marker: "### {mark} 'CurrentCulture' ANSIBLE MANAGED BLOCK ###"
    block: |
      # -------------------------------------------
      # CurrentCulture - Set to 'de-DE'
      # -------------------------------------------
      [System.Threading.Thread]::CurrentThread.CurrentCulture = 'de-DE'
    mode: '0755'

# #################
# ### nnn - plugins
# #################
# - https://github.com/jarun/nnn/tree/master/plugins#installation

- name: All settings misc - nnn - plugins - download install script (all, env_user)
  tags: nnnplugs
  become: true
  become_user: "{{ env_user }}"
  ansible.builtin.get_url:
    url: https://raw.githubusercontent.com/jarun/nnn/master/plugins/getplugs
    dest: "/home/{{ env_user }}/Downloads/getplugs.sh"
    mode: "0777"

- name: All settings misc - nnn - plugins - exec install script (all, env_user)
  tags: nnnplugs
  become: true
  become_user: "{{ env_user }}"
  ansible.builtin.script: "/home/{{ env_user }}/Downloads/getplugs.sh"

# ###############################
# ### xterm (wg. nnn preview-tui)
# ###############################
- name: All settings misc - xterm - touch (User, all)
  tags: nnnplugs
  ansible.builtin.file:
    path: "/home/{{ env_user }}/.Xresources"
    state: touch
    owner: "{{ env_user }}"
    group: "{{ env_user }}"
    mode: u=rw,g=r,o=r

- name: All settings misc - xterm - Insert/Update additional paths and config (User,all)
  tags: nnnplugs
  ansible.builtin.blockinfile:
    path: "/home/{{ env_user }}/.Xresources"
    backup: true
    marker: "### {mark} 'xterm' ANSIBLE MANAGED BLOCK ###"
    block: |
      XTerm*background:   black
      XTerm*foreground:   white
      XTerm*renderFont:   true
      XTerm*faceName:     DejaVuSansMono
      XTerm*faceSize:     13

# #######
# ### zsh
# #######
- name: All settings misc - zsh plugin git update - bash-skript (Debian)
  tags: shellrc
  ansible.builtin.copy:
    src: "files/config_all-services-misc-zshpluginsgit_update.sh"
    dest: "/usr/local/bin/zshpluginsgit_update.sh"
    owner: root
    group: root
    mode: "0755"
    backup: true
  when: ansible_distribution in ["Debian"]

# fatal: detected dubious ownership in repository at '/usr/share/zsh/plugins/... # add an exception:
#
# git_config module instead of:
# become: true # ansible.builtin.shell: /usr/bin/git config --global --add safe.directory /usr/share/zsh/plugins/zsh-autosuggestions
# but: # add_mode: add # as of 11/2024 / ansible [core 2.14.16]: 'add_mode' not available
#
# - name: All settings misc - zsh plugin git repo - add safe.directory - autosuggestions (Debian)
#   tags: shellrc
#   become: true
#   community.general.git_config:
#     name: safe.directory
#     scope: global
#     value: "{{ item }}"
#     add_mode: add # as of 11/2024 / ansible [core 2.14.16]: 'add_mode' not available yet
#   loop:
#     - /usr/share/zsh/plugins/zsh-autosuggestions
#     - /usr/share/zsh/plugins/zsh-syntax-highlighting
#     - /usr/share/zsh/plugins/zsh-history-substring-search
#   when:
#     - ansible_distribution in ["Debian"]

- name: All settings misc - zsh plugin git repo - add safe.directory - autosuggestions (Debian)
  tags: shellrc # , skip_ansible_lint
  become: true
  ansible.builtin.shell: /usr/bin/git config --global --add safe.directory /usr/share/zsh/plugins/zsh-autosuggestions
  when:
    - ansible_distribution in ["Debian"]

- name: All settings misc - zsh plugin git repo - add safe.directory - syntax-highlighting (Debian)
  tags: shellrc # , skip_ansible_lint
  ansible.builtin.shell: /usr/bin/git config --global --add safe.directory /usr/share/zsh/plugins/zsh-syntax-highlighting
  when:
    - ansible_distribution in ["Debian"]

- name: All settings misc - zsh plugin git repo - add safe.directory - history-substring-search (Debian)
  tags: shellrc # , skip_ansible_lint
  ansible.builtin.shell: /usr/bin/git config --global --add safe.directory /usr/share/zsh/plugins/zsh-history-substring-search
  when:
    - ansible_distribution in ["Debian"]

# #######
# ### vim
# #######

# ----------------
# ### VIM Settings

- name: All settings misc - Set vim global config (Debian)
  tags: vimrc
  ansible.builtin.blockinfile:
    path: "/etc/vim/vimrc.local"
    backup: true
    create: true
    mode: "0644"
    marker: '" ### {mark} ANSIBLE MANAGED BLOCK ###'
    block: |
      " #
      syntax on           " Vim5 and later versions support syntax highlighting
      set background=dark " If dark background + syntax highlighting, turn on this option as well

      " The following cause vim to behave a lot differently from regular Vi.
      " They are highly recommended though.
      set showcmd     " Show (partial) command in status line.
      set showmatch   " Show matching brackets.
      set ignorecase  " Do case insensitive matching
      set smartcase   " Do smart case matching
      set incsearch   " Incremental search
      set autowrite   " Automatically save before commands like :next and :make
      set hidden      " Hide buffers when they are abandoned
      set mouse=a     " Enable mouse usage (all modes)

      colorscheme koehler
      set number      " Show line numbers
      set ruler       " Show row and column ruler information
      set listchars=eol:¬,tab:>·,trail:~,extends:>,precedes:<,space:·,nbsp:×
      " set list      " show white space characters " set manual in cmd mode: ':set list'
      " set nolist    " ':set nolist' in cmd mode to disable 'set list'
      set nocompatible
      set tabstop=4   " show existing tab with 4 spaces width
      set shiftwidth=4 " Number of auto-indent spaces; when indentig with '>', use 4 spaces
      set expandtab   " On pressing tab, insert spaces
      set smarttab    " <Tab> in front of a line inserts blanks
      set hlsearch    " Highlight all search results
      set undolevels=1000 " Number of undo levels
      " #
  when:
    - ansible_distribution == "Debian"

- name: All settings misc - Set vim global config (Arch)
  tags: vimrc
  ansible.builtin.blockinfile:
    path: "/etc/vimrc"
    backup: true
    marker: '" ### {mark} ANSIBLE MANAGED BLOCK ###'
    block: |
      " #
      syntax on           " Vim5 and later versions support syntax highlighting
      set background=dark " If dark background + syntax highlighting, turn on this option as well

      " The following cause vim to behave a lot differently from regular Vi.
      " They are highly recommended though.
      set showcmd     " Show (partial) command in status line.
      set showmatch   " Show matching brackets.
      set ignorecase  " Do case insensitive matching
      set smartcase   " Do smart case matching
      set incsearch   " Incremental search
      set autowrite   " Automatically save before commands like :next and :make
      set hidden      " Hide buffers when they are abandoned
      set mouse=a     " Enable mouse usage (all modes)

      colorscheme koehler
      set number      " Show line numbers
      set ruler       " Show row and column ruler information
      set listchars=eol:¬,tab:>·,trail:~,extends:>,precedes:<,space:·,nbsp:×
      " set list      " show white space characters " set manual in cmd mode: ':set list'
      " set nolist    " ':set nolist' in cmd mode to disable 'set list'
      set nocompatible
      set tabstop=4   " show existing tab with 4 spaces width
      set shiftwidth=4 " Number of auto-indent spaces; when indentig with '>', use 4 spaces
      set expandtab   " On pressing tab, insert spaces
      set smarttab    " <Tab> in front of a line inserts blanks
      set hlsearch    " Highlight all search results
      set undolevels=1000 " Number of undo levels
      " #
  when: ansible_distribution == "Archlinux"

# ---------------
# ### VIM plugins
#
# Anmerkung: package "vim-ale" ist installiert über paketmanager
#
# - manuelle Installation für env_user
# -
# - https://opensource.com/article/20/2/how-install-vim-plugins
# - https://github.com/vim/vim/blob/03c3bd9fd094c1aede2e8fe3ad8fd25b9f033053/runtime/doc/repeat.txt#L515

- name: All settings misc - Create folder for vim git-plugins (all)
  tags: vimrc
  become: true
  become_user: "{{ env_user }}"
  ansible.builtin.shell:
    cmd: "mkdir -p /home/{{ env_user }}/.vim/pack/git-plugins/start"
  args:
    creates: /home/{{ env_user }}/.vim/pack/git-plugins/start

- name: All settings misc - vim plugin install from git repo - nnn.vim (all)
  tags: vimrc
  become: true
  become_user: "{{ env_user }}"
  ansible.builtin.git:
    repo: "https://github.com/mcchrish/nnn.vim"
    dest: "/home/{{ env_user }}/.vim/pack/git-plugins/start/nnn.vim"
    depth: 1

- name: All settings misc - vim plugin install from git repo - Powerline (all)
  tags: vimrc
  become: true
  become_user: "{{ env_user }}"
  ansible.builtin.git:
    repo: "https://github.com/powerline/powerline.git"
    dest: "/home/{{ env_user }}/.vim/pack/git-plugins/start/powerline"

- name: All settings misc - vim plugin install from git repo - vim-airline (all)
  tags: vimrc
  become: true
  become_user: "{{ env_user }}"
  ansible.builtin.git:
    repo: "https://github.com/vim-airline/vim-airline.git"
    dest: "/home/{{ env_user }}/.vim/pack/git-plugins/start/vim-airline"

- name: All settings misc - vim plugin install from git repo - vim-fugitive (git) (all)
  tags: vimrc
  become: true
  become_user: "{{ env_user }}"
  ansible.builtin.git:
    repo: "https://github.com/tpope/vim-fugitive.git"
    dest: "/home/{{ env_user }}/.vim/pack/git-plugins/start/vim-fugitive"

# ##########
# ### ClamAV
# ##########

# ### clamd

- name: All settings misc - Set ClamAV - clamd global config - ExcludePath (all)
  ansible.builtin.blockinfile:
    path: "/etc/clamav/clamd.conf"
    backup: true
    create: true
    marker: "# ### {mark} ANSIBLE MANAGED BLOCK - ExcludePath ###"
    block: |
      # Don't scan files and directories matching regex
      # This directive can be used multiple times
      # Default: scan all
      #ExcludePath ^/proc/
      #ExcludePath ^/sys/
      ExcludePath ^/home/.*/\.clam/quarantine
    owner: root
    group: root
    mode: u=rw,g=r,o=r

- name: All settings misc - Set ClamAV - clamd global config - Limits (all)
  ansible.builtin.blockinfile:
    path: "/etc/clamav/clamd.conf"
    backup: true
    marker: "# ### {mark} ANSIBLE MANAGED BLOCK - Limits ###"
    block: |
      # Files larger than this limit won't be scanned. Affects the input file itself
      # as well as files contained inside it (when the input file is an archive, a
      # document or some other kind of container).
      # Value of 0 disables the limit.
      # Note: disabling this limit or setting it too high may result in severe damage
      # to the system.
      # Technical design limitations prevent ClamAV from scanning files greater than
      # 2 GB at this time.
      # Default: 100M
      MaxFileSize 400M

# https://wiki.archlinux.org/title/Desktop_notifications#Bash
# https://wiki.archlinux.org/title/ClamAV
- name: All settings misc - Set ClamAV - clamd global config - VirusEvent - Desktop Notification (all)
  ansible.builtin.blockinfile:
    path: "/etc/clamav/clamd.conf"
    backup: true
    marker: "# ### {mark} ANSIBLE MANAGED BLOCK - VirusEvent ###"
    block: |
      # Execute a command when virus is found. In the command string %v will
      # be replaced with the virus name and %f will be replaced with the file name.
      # Additionally, two environment variables will be defined: $CLAM_VIRUSEVENT_FILENAME
      # and $CLAM_VIRUSEVENT_VIRUSNAME.
      # Default: no
      # VirusEvent /usr/local/bin/send_sms 123456789 "VIRUS ALERT: %v in %f"
      # VirusEvent /usr/bin/notify-send "VirusAlert: '${CLAM_VIRUSEVENT_VIRUSNAME}' in '${CLAM_VIRUSEVENT_FILENAME}'" "Virus found - notification." --icon=dialog-warning
      VirusEvent /etc/clamav/VirusEvent.sh

# https://wiki.archlinux.org/title/ClamAV
- name: All settings misc - Users - clamav - bash-skript VirusEvent - notify-send on signature found (all)
  ansible.builtin.copy:
    src: "files/config_all-settings-misc-clamavVirusEvent.sh"
    dest: "/etc/clamav/VirusEvent.sh"
    owner: root
    group: root
    mode: "0755"
    backup: true

- name: All settings misc - Users - clamav - services - bashScript to scan HOME folder (all)
  ansible.builtin.copy:
    src: "files/config_all-services-misc-clamav-scanHome.sh"
    dest: "/usr/local/bin/scanHome.sh"
    owner: root
    group: root
    mode: "0755"
    backup: true

# ### custom folders (quarantine, logs)
- name: All settings misc - Create 'quarantine' and 'logs' folder for ClamAV for env_user (all)
  ansible.builtin.file:
    path: "/home/{{ env_user }}/{{ item }}"
    state: directory
    owner: "{{ env_user }}"
    group: "{{ env_user }}"
    mode: "0755"
  loop:
    - .clam/logs
    - .clam/quarantine

# #############################################
# # reflector - retrieve the latest mirror list
# #############################################
# Service: siehe "config_all-services-misc.yml"
- name: All settings misc - reflector - insert countries (Arch)
  ansible.builtin.replace:
    path: /etc/xdg/reflector/reflector.conf
    # search_string: '# --country France,Germany'
    regexp: "^# --country France,Germany"
    replace: "--country Germany,France,Austria,Switzerland,Netherlands,Belgium,Sweden"
    backup: true
  when:
    - ansible_distribution in ["Archlinux"]

- name: All settings misc - reflector - how many mirrors to use (Arch)
  ansible.builtin.replace:
    path: /etc/xdg/reflector/reflector.conf
    # search_string: '--latest 5'
    regexp: "^--latest 5"
    replace: "--latest 8"
    backup: true
  when:
    - ansible_distribution in ["Archlinux"]

# ######################
# ### Visual Studio Code
# ######################
# - Arch: will be installed later via chaotic-aur

# - name: All settings misc - Start 'Visual Studio Code' (all)
#   become: true
#   become_user: "{{ env_user }}"
#   ansible.builtin.shell:
#     cmd: code >/dev/null 2>&1 & # damit im Home-Verzeichnis der Config-Pfad von VS Code erstellt wird + später die settings.yml dorthin kopiert werden kann
#   args:
#     creates: "/home/{{ env_user }}/.config/Code/User/globalStorage/zokugun.sync-settings/settings.yml"
#     # nur ausführen, wenn nicht bereits z.B. in vorhergehendem Lauf gestartet/erstellt wurde

- name: All settings misc - Erstelle hilfsweise manuell 'Sync Settings' Extension Ordner für 'VS Code' (all)
  become: true
  become_user: "{{ env_user }}"
  ansible.builtin.file:
    path: "/home/{{ env_user }}/.config/Code/User/globalStorage/zokugun.sync-settings"
    state: directory
    mode: "0775"

# Pfad bei Install des VS Code deb-Pakets (nicht bei flatpak oder snap)
- name: All settings misc - Set/Copy 'Visual Studio Code' settings-file for Extension 'Sync Settings' (all)
  become: true
  become_user: "{{ env_user }}"
  ansible.builtin.copy:
    src: ./files/VSCode_Extension_Sync-Settings_settings.yml
    dest: "/home/{{ env_user }}/.config/Code/User/globalStorage/zokugun.sync-settings/settings.yml"
    owner: "{{ env_user }}"
    group: "{{ env_user }}"
    mode: u=rw

# - name: All settings misc - Close Visual Studio Code (all)
#   become: true
#   become_user: "{{ env_user }}"
#   ansible.builtin.shell:
#     cmd: pkill -15 code # Signal: "-15" entspricht "SIGTERM" : Abschließen und beenden des Programms
#     # cmd: killall code

# ########################
# ### Ulauncher extensions
# ########################

- name: All settings misc - ulauncher - create extension folder (all, env_user)
  become: true
  become_user: "{{ env_user }}"
  ansible.builtin.file:
    path: "/home/{{ env_user }}/.local/share/ulauncher/extensions"
    state: directory
    mode: "0755"

- name: All settings misc - ulauncher - git clone extensions (all, env_user)
  become: true
  become_user: "{{ env_user }}"
  ansible.builtin.git:
    repo: "{{ item.path }}"
    dest: "/home/{{ env_user }}/.local/share/ulauncher/extensions/{{ item.name }}"
    update: true
    clone: true
    # single_branch: true
    # version: "HEAD"   # default: "HEAD"
  loop:
    - { path: "https://github.com/Rapha149/ulauncher-bluetooth.git", name: "ulauncher-bluetooth" }
    - { path: "https://github.com/tchar/ulauncher-albert-calculate-anything.git", name: "ulauncher-albert-calculate-anything" }
    - { path: "https://github.com/sergius02/ulauncher-colorconverter.git", name: "ulauncher-colorconverter" }
    - { path: "https://github.com/Rapha149/ulauncher-deepl.git", name: "ulauncher-deepl" }
    - { path: "https://github.com/Ulauncher/ulauncher-emoji.git", name: "ulauncher-emoji" }
    - { path: "https://github.com/brpaz/ulauncher-faker.git", name: "ulauncher-faker" }
    - { path: "https://github.com/KuenzelIT/ulauncher-firefox-bookmarks.git", name: "ulauncher-firefox-bookmarks" }
    - { path: "https://github.com/hillaryychan/ulauncher-fzf.git", name: "ulauncher-fzf" }
    - { path: "https://github.com/friday/ulauncher-gnome-settings.git", name: "ulauncher-gnome-settings" }
    - { path: "https://github.com/SeoFernando25/ulauncher-gpt.git", name: "ulauncher-gnome-settings" }
    - { path: "https://github.com/pwnyprod/ulauncher-ipcopy.git", name: "ulauncher-ipcopy" }
    - { path: "https://github.com/brpaz/ulauncher-lipsum.git", name: "ulauncher-lipsum" }
    - { path: "https://github.com/RNairn01/ulauncher-meme-my-text.git", name: "ulauncher-meme-my-text" }
    - { path: "https://github.com/melianmiko/ulauncher-nmcli.git", name: "ulauncher-nmcli" }
    - { path: "https://github.com/mastdiekin/ulauncher-pypi-search.git", name: "ulauncher-pypi-search" }
    - { path: "https://github.com/noam09/ulauncher-remmina.git", name: "ulauncher-remmina" }
    - { path: "https://github.com/lighttigerXIV/ulauncher-session-manager.git", name: "ulauncher-session-manager" }
    - { path: "https://github.com/xRealNeon/SpritpreiseUlauncher.git", name: "SpritpreiseUlauncher" }
    - { path: "https://github.com/jyvern/ulauncher-ssh.git", name: "ulauncher-ssh" }
    - { path: "https://github.com/rootwork/ulauncher-symbol.git", name: "ulauncher-symbol" }
    - { path: "https://github.com/lighttigerXIV/ulauncher-terminal-runner-extension.git", name: "ulauncher-terminal-runner-extension" }
    - { path: "https://github.com/Ulauncher/ulauncher-timer.git", name: "ulauncher-timer" }
    - { path: "https://github.com/brpaz/ulauncher-timestamp.git", name: "ulauncher-timestamp" }
    - { path: "https://github.com/dhelmr/ulauncher-tldr.git", name: "ulauncher-tldr" }
    - { path: "https://github.com/zensoup/ulauncher-unicode.git", name: "ulauncher-unicode" }
    - { path: "https://github.com/NastuzziSamy/ulauncher-youtube-search.git", name: "ulauncher-youtube-search" }
